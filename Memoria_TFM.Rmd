---
title: "Memoria_TFM"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
 
```

## 1. Introduccion

El Trabajo Fin de Máster consistirá en analizar el impacto de diversos factores en el retraso de los vuelos.
Se añadiran datos climáticos al dataset de entrada y se estudiará el impacto del clima y del resto de variables sobre el retraso de los vuelos.

Para realizar el presente trabajo se han usado los lenguajes Python (con los notebooks de jupyter) y R.

## 2. Análisis del dataset de entrada

A continuación se muestra un breve análisis de las variables del dataset de entrada:

```{r dataset, echo=FALSE}
vuelos <- read.table("operations_leg.csv", header = T, sep = "^")
```
```{r str}
str(vuelos)
```

Como se puede apreciar, el dataset de entrada esta compuesto por 222012 objetos y 65 variables.
Los tipos de las variables son variados, existiendo los siguientes: logi, int, num y factor.


```{r summary}
summary(vuelos)
```

Ejecutando el comando "summary"" observamos lo siguiente:

* Varias variables únicamente contienen valores NAs, por lo tanto deberan ser eliminadas.
* El codigo de aerolinea que más se utiliza es XX. Podemos entender no existía un código y se rellene este campo con XX.
* La mayoría de vuelos tiene el valor **Departed** en su código de estado (variable general_status_code). 
* La mayoría de los vuelos despegan y aterrizan en aeropuertos Españoles.
* La máxima distancia de un vuelo son 9275 kil?metros y la mínima son 123 kilómetros.
* Existen vuelos que llegan a su destino con 59 minutos de adelanto así como existen vuelos que llegan a su destino con 59 minutos de retraso.
* Existen vuelos que despegan de su origen con 59 minutos de adelanto así como existen vuelos que despegan de su origen con 59 minutos de retraso.
* La media de piezas de equipajes en los aviones es de 61.

* Información sobre las fechas de los vuelos:
```{r lubridate,echo=FALSE,include=FALSE}
library(lubridate)
```

La siguiente gráfica muestra una relacion de los vuelos por año.
```{r actual_time_of_arrival,out.width='100%'}
barplot(table(year(ymd_hms(vuelos$actual_time_of_departure))))
```
De la gráfica anterior se puede observar que los vuelos estan concentrados en el año 2016.
A continuación se indica el número de vuelos que se ha realizado cada año.
```{r tabla anyos}
table(year(ymd_hms(vuelos$actual_time_of_departure)))
```
La siguiente gr?fica muestra la relacion entre los vuelos y los meses del a?o:
```{r mes actual_time_of_arrival, out.width='100%'}
barplot(table(month(ymd_hms(vuelos$actual_time_of_departure))))
```
De la gráfica anterior determinamos que los meses en los que más vuelos se hacen son Enero, Febrero y Marzo.


El siguiente boxplot muestra informacion de la distancia de los vuelos:
```{r distancia vuelo,out.width='100%'}
boxplot(vuelos$distance, main="Distancia vuelos")
summary(vuelos$distance)
```
Del boxplot anterior determinamos que la distancia media realizada en los vuelos es de 925 km.
El vuelo que menos distancia recorrió fueron 123 km y el vuelo que más distancia recorrio fueron 9275 km.


La siguiente gráfica muestra informacion sobre el retraso de llegada para los vuelos.
```{r retraso llegada,out.width='100%'}
boxplot(vuelos$arrival_delay, main="Retraso llegada")
summary(vuelos$arrival_delay)
```
Observando la gráfica anterior vemos que los retrasos de llegada de los vuelos se concentran entre -9 y 7 minutos.


Teniendo en cuenta esta primera observación de los datos en bruto, analizaremos cada variable con el fin de obtener el máximo de información posible antes de aplicar cualquier modelo.


## 3. Metodología a utilizar

3.1. La primera accion a tomar sera obtener el conjunto de datos a analizar. Para ello, nos fijamos en la variable **general status code**. Obtendremos aquellos registros cuyo valor para esta variable sea **Departed**.

3.2. El siguiente paso será limpiar los datos, analizar las variables de entrada, eliminar los NAs en el caso de ser posible, comprobar que los datos son correctos y crear nuevas variables en base a los datos existentes (siempre que sea posible y tenga sentido).

3.3 Se añadiran datos climaticos al dataset de entrada en funcion de las coordenadas geograficas.

Los pasos seguidos en orden para el tratamiento de datos y para añadir datos climaticos se incluyen en los archivos adjuntos:

* 1 -DescripcionDatosEntrada_01.r

* 2 -GraficasDatos.r

* 3 -ScriptWeather.ipynb  -> se debe abrir con la herramienta jupyter notebook (python)

* 4 -DescripcionDatosEntrada_02


Para visualizar como se ha sido el proceso de agregación de datos atmósfericos, se puede ver el anexo adjuntado en el repositorio llamado:
**ScriptWeather.md**

3.4 Normalización.

Para realizar un mejor estudio, hemos decidido normalizar los datos que tenemos. 
Para ello se ejecuta la primera parte del archivo en R:

* 5 -Normalizacion_modelizacion.r




3.5. Se utilizaran diferentes algoritmos para determinar las variables que mas influyen en el retraso de los vuelos.
Aplicaremos diferentes modelos y formas para analizar los datos que tenemos.

* Regresion Lineal


Primero tomamos una muestra aleatoria y luego vemos como influyen todas las variables respecto al retraso de la salida del vuelo:
```{r summary2}
vuelosNormalizado <- read.table("vuelosNormalizado.csv", header = T, sep = ",")
indices <- sample( 1:nrow( vuelosNormalizado ), 150000 )
muestra <- vuelosNormalizado[ indices, ]

modelCom1 =lm(arrival_delay ~ ., na.action = na.omit, data = muestra)
#summary(modelCom1)
##para hacer el modelo con las variables deseadas
model1 <- lm(departure_delay ~ distance+act_blocktime+cabin_1_fitted_configuration+
               cabin_1_saleable+cabin_1_pax_boarded+cabin_1_rpk+cabin_1_ask+total_rpk+total_ask+load_factor+total_pax+
               total_no_shows+total_cabin_crew+total_technical_crew+total_baggage_weight+
               number_of_baggage_pieces+pesosFligthNumber+
               pesosBoardPoint+pesosBoardLat+pesosBoardLon+pesosBoardCountryCode+pesosOffPoint+
               pesoOffLat+pesoOffLon+pesoOffCountryCode+pesoAircraftType+pesoRouting+
               pesoMesSalida+pesoDiaSalida+pesoHoraSalida+pesoMesLlegada+pesoDiaLlegada+
               pesoHoraLlegada, 
             na.action = na.omit, data = vuelosNormalizado)

summary(model1)
```


Vamos a ver ahora que variables climáticas afectan más al retraso de la salida del vuelo:
```{r summary3}
model1b <- lm(departure_delay ~ TMIN_o+TMIN_d+TMAX_o+TMAX_d+
            TAVG_o+TAVG_d+PRCP_o+PRCP_d+SNWD_o+SNWD_d, 
             na.action = na.omit, data = vuelosNormalizado)

summary(model1b)
hist(model1b$residuals)

```



* Regresion Logistica
Para la regresión logística se han realizado los siguientes comandos:

```{r summary4}
set.seed(1)
muestra         <- sample(nrow(vuelosNormalizado),nrow(vuelosNormalizado)*.3)
Train           <- vuelosNormalizado[-muestra,]
Test            <- vuelosNormalizado[muestra,]

model3     <- glm(departure_delay ~., Train, family = binomial(link="logit"))
summary(model3)
```

* Random Forest
```{r summary4}
set.seed(1)
indices <- sample( 1:nrow( vuelosNormalizado ), 10000 )
muestra <- vuelosNormalizado[ indices, ]
rf <- randomForest(departure_delay ~ .,na.action=na.omit,proximity=TRUE,
                   keep.forest=FALSE, data=muestra)
 

importance(rf)#para ver que variables son mas importantes
MDSplot(rf, muestra$departure_delay)
 
```

* PCA
```{r summary4}
##ELEGIR VARIABLES QUE NO SEAN NULAS  O CONSTANTES
vuelosPCA <- data.frame("TMIN_o" = vuelosNormalizado$TMIN_o, 
                  "TMIN_d" = vuelosNormalizado$TMIN_d, 
                  "TMAX_o" = vuelosNormalizado$TMAX_o,
                  "TMAX_d" = vuelosNormalizado$TMAX_d,
                  "TAVG_o" = vuelosNormalizado$TAVG_o,
                  "TAVG_d" = vuelosNormalizado$TAVG_d,                 
                  "distance" = vuelosNormalizado$distance, 
                  "departure_delay" = vuelosNormalizado$departure_delay,
                  "arrival_delay" = vuelosNormalizado$arrival_delay,
                  "est_blocktime" = vuelosNormalizado$est_blocktime,
                  "act_blocktime" = vuelosNormalizado$act_blocktime,
                  "PRCP_o" = vuelosNormalizado$PRCP_o,
                  "PRCP_d" = vuelosNormalizado$PRCP_d,
                  "pesoHoraLlegada" = vuelosNormalizado$pesoHoraLlegada,
                  "pesoDiaLlegada" = vuelosNormalizado$pesoDiaLlegada,
                  "pesoMesLlegada" = vuelosNormalizado$pesoMesLlegada,
                  "pesoHoraSalida" = vuelosNormalizado$pesoHoraSalida,
                  "pesoDiaSalida" = vuelosNormalizado$pesoDiaSalida,
                  "pesoMesSalida" = vuelosNormalizado$pesoMesSalida,
                  "pesoRouting" = vuelosNormalizado$pesoRouting,
                  "pesoAircraftRegNumber" = vuelosNormalizado$pesoAircraftRegNumber,
                  "pesoAircraftType" = vuelosNormalizado$pesoAircraftType
                  
                  ) 


PCA<-prcomp(vuelosPCA[,-c(1)],scale. = TRUE)

summary(PCA)
biplot(PCA)
```
* Comparativa de los Modelos Anteriores
Si comparamos los modelos anteriores, podemos ver que nos apuntan a la misma dirección.




## 4. Conclusiones y resumen de resultados

Como conclusiones se puede indicar que las variables que más influyen en el retraso de los vuelos analizados son:

* la distancia.

* Las características del avión, como el peso.

* La hora de salida.

* La temperatura media.

* La ruta del vuelo.


Es decir hay motivos obvios, como la de la hora del vuelo, si un vuelo esta programado por la tarde noche, es normal que se retrase ese vuelo.


En cuanto al análisis de variables atmósfericas, se puede deducir que no son demasiado influyentes como otras variables. La temperatura es la variable que más influye. Otras condiciones climáticas no parecen ser relevantes.






